Включение возможности аутентификации по сертификату начинается с редактирования конфигурационного файла postgresql.conf, который можно найти по пути `/etc/postgresql/"версия postgres"/main/`. Ниже представлена возможная конфигурация

![[Pasted image 20230829171842.png]]

Где:
`ssl` - строка для включения ssl, она может иметь одно из двух значений: on/off.
`ssl_ca_file` - путь до корневого удостоверяющего сертификата
`ssl_cert_file` - путь до сертификата сервера баз данных
`ssl_key_file` - путь до закрытого ключа сервера

Для запуска в режиме SSL должны существовать файлы, содержащие сертификат сервера, закрытый ключ и корневой сертификат. По умолчанию ожидается, что эти файлы будут иметь имена `server.crt` и `server.key` соответственно. Чтобы создать простой само заверяющий сертификат для сервера, действительный в течение 365 дней, используйте следующую команду OpenSSL `dbhost.yourdomain.com`, заменив ее именем хоста сервера:
   
   ```
   openssl req -new -x509 -days 365 -nodes -text -out server.crt -keyout server.key -subj "/CN= root.yourdomain.com" 
   ```
   
Далее необходимо выполнить команду выдачи прав на ключ сервера, потому что сервер отклонит файл, если его разрешения более высоки, чем эти:
   
   ```
   chmod og-rwx server.key
   ```
   
Хотя для тестирования можно использовать само заверяющий сертификат, в рабочей среде следует использовать сертификат, подписанный центром сертификации ( CA ) (обычно корневым центром сертификации в масштабе всего предприятия).

Чтобы создать сертификат сервера, личность которого может быть проверена клиентами, сначала создайте запрос на подпись сертификата ( CSR ) и файл открытого/закрытого ключа:

   ```
   openssl req -new -nodes -text -out root.csr -keyout root.key -subj "/CN= root.yourdomain.com" 
   ```
   
Далее необходимо также выдать права на root.key:
   
   ```
   chmod og-rwx root.key
   ```
   
Затем необходимо подпиcать запрос ключом для создания корневого центра сертификации:
   
   ```
   openssl x509 -req -in root.csr -text -days 3650 \
   -extfile /etc/ssl/openssl.cnf -extensions v3_ca \
   -signkey root.key -out root.crt   
   ```
   
После этого можно создать сертификат и закрытый ключ сервера, подписанный новым корневым центром сертификации:
   
   ```
   openssl req -new -nodes -text -out server.csr -keyout server.key -subj "/CN=dbhost.yourdomain.com"
   
   chmod og-rwx server.key
   
   openssl x509 -req -in server.csr -text -days 365 -CA root.crt -CAkey root.key -CAcreateserial -out server.crt
   ```

`server.crt` и `server.key` должен храниться на сервере, `root.crt` - на клиенте, чтобы пользователь мог проверить, что конечный сертификат сервера был подписан его доверенным корневым сертификатом. `root.key` следует хранить в автономном режиме для использования при создании будущих сертификатов.

Следующим этапом необходимо поменять файл `pg_hba.conf`. Если необходимо оставить только возможность аутентификации по сертификату, то закомменчиваются все строки, помимо hostssl. 

В строке hosstssl мы указываем, что для любых пользователей, для любых бд и для любых ip  аутентификация происходит исключительно по сертификату с полной проверкой.

Строку с local можно оставить, чтобы заходить с машины в бд по паролю.

![[Pasted image 20230901130155.png]]

Процесс создания клиентского сертификата и закрытого ключа аналогичен процессу создания сертификата и закрытого ключа сервера, описанному выше. Важно отметить, что при создании сертификата клиента в строке CN= необходимо указать hostname машины, с которой будут подключаться к БД. В ОС Linux свой hostname можно узнать командой hostname. Пользователи Windows могут узнать свое имя в "Сведения о системе" просто вбив строку в поиске.

Помимо выдачи сертификата для клиента необходимо в самой базе данных создать пользователя с аналогичным именем и выдать ему необходимые права.
Также в файл host необходимо прописать соответствие ip сервера - имя сервера в сертификате (CN) и при подключении указывать не ip, а имя хоста.

После изменения конфигурационных файлов необходимо перезапустить службу postgres.

Если служба не стартует логи можно посмотреть при помощи следующей команды:

```
nano /etc/postgresql/"версия postgres"/main/
```

Ниже показан пример подключения у БД при помощи ПО DBeaver и через командную строку Linux. 

![[Pasted image 20230901125531.png]]

![[Pasted image 20230901125614.png]]

![[Pasted image 20230901130000.png]]

---

### Про подключение через SSL к другим БД

[[SSL MySQL]]
